{% extends "base.html" %}

{% block title %}View Expenses - Spending Tracker{% endblock %}

{% block head %}
{{ super() }}
<!-- Add Chart.js with defer to ensure it loads after DOM is ready -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js" defer></script>
<style>
    /* Custom styles for collapsible cards */
    .card-header[role="button"] {
        cursor: pointer;
    }
    .card-header[role="button"]:hover {
        background-color: rgba(0,0,0,0.03);
    }
    .card-header .bi-chevron-down {
        transition: transform 0.3s ease;
    }
    .collapse:not(.show) + .card-header .bi-chevron-down,
    .collapsed .bi-chevron-down {
        transform: rotate(-90deg);
    }
    
    /* Pagination styles */
    .pagination .page-link {
        color: #6c47de;
        border-color: #e9ecef;
    }
    .pagination .page-item.active .page-link {
        background-color: #6c47de;
        border-color: #6c47de;
        color: white;
    }
    .pagination .page-item.disabled .page-link {
        color: #6c757d;
    }
    .pagination .page-link:hover {
        background-color: #f8f9fa;
        border-color: #dee2e6;
        color: #5a3cbf;
    }
</style>
{% endblock %}


{% block content %}
<div class="container-fluid px-4 mb-4">
    <div class="row">
        <div class="col-12 d-flex justify-content-between align-items-center flex-wrap">
            <!-- Enhanced Month Selection Area -->
<div class="card shadow-sm mb-3" style="background: linear-gradient(90deg, #6c47de 0%, #8f5ff7 100%); border-radius: 1rem;">
  <div class="card-body py-3">
    <form action="{{ url_for('expense_routes.view_expenses') }}" method="GET" id="monthForm" class="mb-0">
      <div class="input-group input-group-lg flex-nowrap" style="min-width: 350px; max-width: 480px;"> <!-- Increased width -->
        <span class="input-group-text bg-white border-0" style="border-top-left-radius: 0.75rem; border-bottom-left-radius: 0.75rem; padding-left: 1.25rem; padding-right: 1.25rem;">
          <i class="bi bi-calendar3 text-primary"></i>
        </span>
        <select class="form-select form-select-lg border-0 flex-grow-1" name="month_id" id="month_id" style="min-width: 160px; font-size: 1.35rem; padding: 0.85rem 1.25rem; border-radius: 0;" onchange="this.form.submit()">
          {% for month in all_months %}
            <option value="{{ month.id }}" {% if month.id == month_data.id %}selected{% endif %}>
              {{ "%02d"|format(month.month) }}/{{ month.year }}
              {% if expenses|selectattr('is_recurring_instance', 'defined')|selectattr('is_recurring_instance')|list|length > 0 and month.id == month_data.id %}
                <span class="text-primary"> â€¢ </span>
              {% endif %}
            </option>
          {% endfor %}
        </select>
        {% set month_names = ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'] %}
        <span class="input-group-text bg-transparent border-0 ps-3 pe-4" style="font-size: 1.7rem; color: #fff; font-weight: 700; text-shadow: 0 1px 8px #6c47de; min-width: 80px;">
          {{ month_names[month_data['month']] }}
        </span>
      </div>
    </form>
  </div>
</div>
<!-- End Enhanced Month Selection Area -->
            <div class="mt-3 mt-md-0">
                <button type="button" class="btn btn-outline-primary me-2 position-relative" data-bs-toggle="modal" data-bs-target="#filtersModal">
                    <i class="bi bi-funnel me-1"></i> Filters
                    {% if expense_type_filter != 'all' or sort_by != 'date' or sort_order != 'desc' %}
                        <span class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle">
                            <span class="visually-hidden">Filters applied</span>
                        </span>
                    {% endif %}
                </button>
                <button type="button" class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#addExpenseModal">
                    <i class="bi bi-plus-circle me-1"></i> Add New Expense
                </button>
                <a href="{{ url_for('index') }}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left me-1"></i> Back to Dashboard
                </a>
            </div>
        </div>
        <hr>
    </div>
</div>

<!-- Filters Modal -->
<div class="modal fade" id="filtersModal" tabindex="-1" aria-labelledby="filtersModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="filtersModalLabel">Filters</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form action="{{ url_for('expense_routes.view_expenses') }}" method="GET" id="filterForm">
          <input type="hidden" name="month_id" value="{{ month_data.id }}">
          <div class="mb-3">
            <label for="expense_type_id" class="form-label">Expense Type</label>
            <select class="form-select" id="expense_type_id" name="expense_type_id">
              <option value="all" {% if expense_type_filter == 'all' %}selected{% endif %}>All Types</option>
              {% for type in expense_types %}
                <option value="{{ type.id }}" {% if expense_type_filter|string == type.id|string %}selected{% endif %}>{{ type.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label for="sort_by" class="form-label">Sort By</label>
            <select class="form-select" id="sort_by" name="sort_by">
              <option value="date" {% if sort_by == 'date' %}selected{% endif %}>Date</option>
              <option value="amount" {% if sort_by == 'amount' %}selected{% endif %}>Amount</option>
              <option value="expense_type" {% if sort_by == 'expense_type' %}selected{% endif %}>Expense Type</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="sort_order" class="form-label">Order</label>
            <select class="form-select" id="sort_order" name="sort_order">
              <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Ascending</option>
              <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>Descending</option>
            </select>
          </div>
          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-filter me-1"></i> Apply Filters
            </button>
            <a href="{{ url_for('expense_routes.view_expenses', month_id=month_data.id) }}" class="btn btn-outline-secondary">
              <i class="bi bi-x-circle me-1"></i> Clear Filters
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>


<!-- Split View: Main Content with Sidebar -->
<div class="container-fluid px-4 mb-4">
    <div class="row gx-0">
        <div class="col-12">
            <!-- Month Summary -->
            <div class="card card-custom bg-light shadow-sm mb-4">
                <div class="card-header section-header">
    <h5 class="section-header-title">Month Summary</h5>
</div>
                <div class="card-body">
                    <div class="row">
                        <!-- Left: Stacked Monthly Income & Ending Balance -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="card card-monthly-income mb-3">
    <div class="card-body">
        <h5 class="section-header-title">Monthly Income</h5>
        <p class="card-text h3">${{ "%.2f"|format(month_data['monthly_income']) }}</p>
    </div>
</div>
<div class="card card-total-expenses mb-3">
    <div class="card-body">
        <h5 class="section-header-title">Total Expenses</h5>
        <p class="card-text h3 mb-0">${{ "%.2f"|format(total_amount) }}</p>
    </div>
</div>
<div class="card card-ending-balance mb-3 bg-success text-white shadow-sm" style="border-radius: 0.75rem;">
    <div class="card-body">
        <h5 class="section-header-title">Ending Balance</h5>
        <p class="card-text h3 mb-0">${{ "%.2f"|format(month_data['starting_bank_value'] + month_data['monthly_income'] - total_amount) }}</p>
    </div>
</div>

{% set recurring_expenses = expenses|selectattr('is_recurring_instance', 'defined')|selectattr('is_recurring_instance')|list %}
{% if recurring_expenses|length > 0 %}
<div class="card mb-3 shadow-sm" style="border-radius: 0.75rem; border-left: 3px solid #0d6efd;">
    <div class="card-body">
        <div class="d-flex align-items-center">
            <i class="bi bi-arrow-repeat text-primary me-2" style="font-size: 1.5rem;"></i>
            <h5 class="card-title mb-0">Recurring Expenses This Month</h5>
        </div>
        <p class="text-muted mt-2 mb-2">The following recurring expenses are automatically included in this month:</p>
        <div class="table-responsive">
            <table class="table table-sm table-borderless mb-0">
                <tbody>
                    {% for expense in recurring_expenses %}
                    <tr>
                        <td><span class="badge bg-{{ 'info' if expense.recurring_interval == 'monthly' else 'primary' if expense.recurring_interval == 'biannual' else 'success' }}">{{ expense.recurring_interval|capitalize }}</span></td>
                        <td>{{ expense.description }}</td>
                        <td class="text-end">${{ "%.2f"|format(expense.amount) }}</td>
                    </tr>
                    {% endfor %}
                    <tr class="border-top">
                        <td colspan="2" class="fw-bold">Total Recurring Expenses:</td>
                        <td class="text-end fw-bold">${{ "%.2f"|format(recurring_expenses|sum(attribute='amount')) }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}
                            </div>
                        </div>
                        <!-- Right: Pie Chart -->
                        <div class="col-md-6 d-flex align-items-center justify-content-center">
                            <div class="w-100">
                                <div class="card card-custom bg-light shadow-sm h-100">
                                    <div class="card-header section-header">
    <h5 class="section-header-title">Expense Distribution by Type</h5>
</div>
                                    <div class="card-body">
                                        {% if expenses %}
                                        <div class="chart-container" style="position: relative; height:260px;">
                                            <canvas id="expenseTypeChart"></canvas>
                                        </div>
                                        {% else %}
                                        <div class="alert alert-info">
                                            <i class="bi bi-info-circle me-2"></i> No data available for chart.
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Expenses Table -->
        <div class="container-fluid px-0">
            <div class="row">
                <div class="col-12">
                    <div class="card card-custom bg-light shadow-sm">
                        <div class="card-header section-header">
    <h5 class="section-header-title">Expense List</h5>
</div>
            <div class="card-body">
                {% if expenses %}
                    <div class="table-responsive">
                        <table class="table table-hover table-sm table-bordered expense-table">
                            <thead class="table-light">
                                <tr>
                                    <th class="text-center align-middle">Date</th>
<th class="text-center align-middle">Description</th>
<th class="text-center align-middle">Type</th>
<th class="text-center align-middle">Amount</th>
<th class="text-center align-middle">Recurring</th>
<th class="text-center align-middle">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for expense in expenses %}
                                    <tr class="{% if loop.index is divisibleby 2 %}alt-row{% endif %} {% if expense.is_recurring_instance is defined and expense.is_recurring_instance %}recurring-instance-row{% endif %} align-middle"
                                       {% if expense.is_recurring_instance is defined and expense.is_recurring_instance %}
                                       data-bs-toggle="tooltip" 
                                       data-bs-html="true"
                                       title="<strong>Auto-generated Recurring Expense</strong><br>This is an instance of a recurring {{ expense.recurring_interval }} expense.<br>Original date: {{ expense.date }}<br>To edit, modify the original recurring expense."
                                       {% endif %}>
                                        <td class="text-center align-middle">
                                            {{ expense.date }}
                                            {% if expense.is_recurring_instance is defined and expense.is_recurring_instance %}
                                                <i class="bi bi-arrow-repeat text-primary" title="Recurring instance"></i>
                                            {% endif %}
                                        </td>
                                        <td class="text-center align-middle">{{ expense.description or 'N/A' }}</td>
                                        <td class="text-center align-middle">
    <span class="badge bg-secondary">{{ expense.expense_type_name }}</span>
</td>
                                        <td class="text-center align-middle">${{ expense.amount|round(2) }}</td>
                                        <td class="text-center align-middle">
    {% if expense.recurring_interval != 'none' %}
        {% if expense.recurring_interval == 'monthly' %}
            <span class="badge bg-info">Monthly (Day {{ expense.recurring_day }})</span>
        {% elif expense.recurring_interval == 'biannual' %}
            <span class="badge bg-primary">Every 6 months</span>
        {% elif expense.recurring_interval == 'yearly' %}
            <span class="badge bg-success">Yearly</span>
        {% endif %}
        {% if expense.is_recurring_instance is defined and expense.is_recurring_instance %}
            <span class="badge bg-warning text-dark">Auto-generated</span>
        {% endif %}
    {% else %}
        <span class="badge bg-light text-dark">No</span>
    {% endif %}
</td>
                                        <td class="actions-cell">
    <div class="btn-group btn-group-sm align-middle" role="group">
        {% if expense.is_recurring_instance is defined and expense.is_recurring_instance %}
            <!-- For recurring instances, show different actions -->
            <button type="button" class="btn btn-outline-primary" 
                    onclick="alert('This is an auto-generated recurring expense. To modify it, please edit the original recurring expense.')">
                <i class="bi bi-info-circle"></i> Info
            </button>
            <!-- Add a button to navigate to the original expense -->
            <a href="#" class="btn btn-outline-secondary" 
               onclick="alert('This expense is generated from a recurring expense template. The original expense was created on ' + '{{ expense.date }}' + '.')">
                <i class="bi bi-arrow-up-right-circle"></i>
            </a>
        {% else %}
            <!-- Regular expense actions -->
            <button type="button" class="btn btn-outline-primary edit-expense-btn" 
                    data-expense-id="{{ expense.id }}"
                    data-amount="{{ expense.amount }}"
                    data-description="{{ expense.description }}"
                    data-expense-type-id="{{ expense.expense_type_id }}"
                    data-date="{{ expense.date }}"
                    data-recurring-interval="{{ expense.recurring_interval }}"
                    data-recurring-day="{{ expense.recurring_day }}">
                <i class="bi bi-pencil"></i>
            </button>
            <button type="button" class="btn btn-outline-danger delete-expense-btn" 
                    data-expense-id="{{ expense.id }}"
                    data-description="{{ expense.description }}">
                <i class="bi bi-trash"></i>
            </button>
        {% endif %}
    </div>
</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination Controls -->
                    {% if total_pages > 1 %}
                    <div class="d-flex justify-content-center mt-4">
                        <nav aria-label="Expense pagination">
                            <ul class="pagination">
                                <!-- Previous Page Button -->
                                <li class="page-item {% if page == 1 %}disabled{% endif %}">
                                    <a class="page-link" href="{{ url_for('expense_routes.view_expenses', month_id=month_data.id, page=page-1, expense_type_id=expense_type_filter, sort_by=sort_by, sort_order=sort_order) }}" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                
                                <!-- Page Numbers -->
                                {% for p in range(1, total_pages + 1) %}
                                    {% if p == page %}
                                        <li class="page-item active"><span class="page-link">{{ p }}</span></li>
                                    {% elif p <= 3 or p >= total_pages - 2 or (p >= page - 1 and p <= page + 1) %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('expense_routes.view_expenses', month_id=month_data.id, page=p, expense_type_id=expense_type_filter, sort_by=sort_by, sort_order=sort_order) }}">{{ p }}</a>
                                        </li>
                                    {% elif p == 4 and page > 4 or p == total_pages - 3 and page < total_pages - 3 %}
                                        <li class="page-item disabled"><span class="page-link">...</span></li>
                                    {% endif %}
                                {% endfor %}
                                
                                <!-- Next Page Button -->
                                <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                                    <a class="page-link" href="{{ url_for('expense_routes.view_expenses', month_id=month_data.id, page=page+1, expense_type_id=expense_type_filter, sort_by=sort_by, sort_order=sort_order) }}" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i> No expenses found for this month and filter criteria.
                    </div>
                {% endif %}
            </div>
        </div>
            </div>
            

</div>

<!-- Add Expense link is now in the header -->

<!-- Hidden element to store expense data for charts -->
{% if all_expenses %}
<script id="expense-data" type="application/json">
{
    "expenses": [
        {% for expense in all_expenses %}
            {
                "date": "{{ expense.date }}",
                "amount": {{ expense.amount }},
                "expense_type_name": "{{ expense.expense_type_name|replace('"', '\\\\')|safe }}"
            }{% if not loop.last %},{% endif %}
        {% endfor %}
    ],
    "month_data": {
        "year": {{ month_data.year }},
        "month": {{ month_data.month }}
    }
}
</script>
{% else %}
<!-- Create empty data structure when no expenses exist -->
<script id="expense-data" type="application/json">
{
    "expenses": [],
    "month_data": {
        "year": {{ month_data.year }},
        "month": {{ month_data.month }}
    }
}
</script>
{% endif %}

<script>
// Process expense data for charts
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, checking for chart elements');
    // Check if expense data and chart canvas are available
    const expenseDataElement = document.getElementById('expense-data');
    const chartCanvas = document.getElementById('expenseTypeChart');
    
    console.log('Expense data element exists:', !!expenseDataElement);
    console.log('Chart canvas exists:', !!chartCanvas);
    
    // Define Chart globally if it's not defined yet (handles potential loading order issues)
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded. Attempting to reload...');
        // Create a script element to load Chart.js again
        const chartScript = document.createElement('script');
        chartScript.src = 'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js';
        chartScript.onload = function() {
            console.log('Chart.js loaded successfully');
            // Now try to initialize the chart again
            initializeChart();
        };
        chartScript.onerror = function() {
            console.error('Failed to load Chart.js');
            if (chartCanvas) {
                chartCanvas.parentNode.innerHTML = '<div class="alert alert-danger">Failed to load Chart.js library</div>';
            }
        };
        document.head.appendChild(chartScript);
        return;
    }
    
    // Initialize the chart
    initializeChart();
    
    function initializeChart() {
        if (expenseDataElement && chartCanvas) {
            try {
                // Parse the JSON data
                const jsonContent = expenseDataElement.textContent.trim();
                console.log('Raw JSON data:', jsonContent);
                
                let data, expenses;
                try {
                    data = JSON.parse(jsonContent);
                    expenses = data.expenses;
                    console.log('Parsed expenses:', expenses);
                } catch (parseError) {
                    console.error('Failed to parse JSON data:', parseError);
                    // Create a message in the chart container
                    chartCanvas.parentNode.innerHTML = '<div class="alert alert-danger">Error loading chart data</div>';
                    return;
                }
                
                if (!expenses || expenses.length === 0) {
                    console.warn('No expenses data available for chart');
                    chartCanvas.parentNode.innerHTML = '<div class="alert alert-info">No expense data available for the selected month</div>';
                    return;
                }
                
                // Data for expense type distribution chart (pie chart)
                const expensesByType = {};
                
                // Generate a color palette for expense types
                const colorPalette = [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                    '#FF9F40', '#8AC54B', '#EA526F', '#23B5D3', '#279AF1',
                    '#7E77F9', '#A288E3', '#BDCCF4', '#9ED8DB', '#FF9A76'
                ];
                
                // Process expense data by type
                expenses.forEach(expense => {
                    try {
                        const typeName = expense.expense_type_name;
                        const amount = parseFloat(expense.amount);
                        
                        if (isNaN(amount)) {
                            console.warn('Invalid amount for expense:', expense);
                            return; // Skip this expense
                        }
                        
                        if (!expensesByType[typeName]) {
                            expensesByType[typeName] = 0;
                        }
                        
                        expensesByType[typeName] += amount;
                    } catch (expenseError) {
                        console.warn('Error processing expense:', expense, expenseError);
                    }
                });
                
                console.log('Expenses by type:', expensesByType);
                
                // Prepare data for pie chart
                const typeLabels = Object.keys(expensesByType);
                const typeData = typeLabels.map(type => expensesByType[type]);
                
                console.log('Chart labels:', typeLabels);
                console.log('Chart data:', typeData);
                
                if (typeLabels.length === 0) {
                    console.warn('No expense types to display in chart');
                    chartCanvas.parentNode.innerHTML = '<div class="alert alert-info">No expense data available for chart</div>';
                    return;
                }
                
                const backgroundColors = colorPalette.slice(0, typeLabels.length);
                
                // Ensure the canvas is cleared before creating a new chart
                const ctx = chartCanvas.getContext('2d');
                ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
                
                // Create the expense type pie chart
                if (window.expenseChart) {
                    window.expenseChart.destroy();
                }
                
                window.expenseChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: typeLabels,
                        datasets: [{
                            data: typeData,
                            backgroundColor: backgroundColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    boxWidth: 15,
                                    padding: 15
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((acc, val) => acc + val, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: $${value.toFixed(2)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
                
                console.log('Chart created successfully');
            } catch (error) {
                console.error('Error creating charts:', error);
                console.error('Error details:', error.message);
                chartCanvas.parentNode.innerHTML = '<div class="alert alert-danger">Error creating chart: ' + error.message + '</div>';
            }
        } else {
            console.error('Chart elements not found');
            if (chartCanvas) {
                chartCanvas.parentNode.innerHTML = '<div class="alert alert-warning">Missing data for chart</div>';
            }
        }
    }
});
</script>

<!-- Hidden inputs for modal control -->
<input type="hidden" id="show_modal" value="{{ 'true' if error or show_modal else 'false' }}">

<!-- Add Expense Modal -->
<div class="modal fade" id="addExpenseModal" tabindex="-1" aria-labelledby="addExpenseModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="section-header d-flex align-items-center justify-content-between w-100" style="border-radius: 0.75rem 0.75rem 0 0;">
  <span class="section-header-title mb-0" id="addExpenseModalLabel">Add New Expense</span>
  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
      <div class="modal-body">
        {% if error %}
            <div class="alert alert-danger" role="alert">
                {{ error }}
            </div>
        {% endif %}

        <form id="addExpenseForm" method="POST" action="{{ url_for('add_expense') }}">
            <div class="mb-3">
                <label for="amount" class="form-label">Amount ($)</label>
                <input type="number" step="0.01" class="form-control" id="amount" name="amount" required>
            </div>

            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea class="form-control" id="description" name="description" rows="3"></textarea>
            </div>

            <div class="mb-3">
                <label for="expense_type_id" class="form-label">Expense Type</label>
                <select class="form-select" id="expense_type_id" name="expense_type_id" required>
                    <option value="" disabled selected>Select an expense type</option>
                    {% for type in expense_types %}
                        <option value="{{ type.id }}">{{ type.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label for="date" class="form-label">Date</label>
                <input type="date" class="form-control" id="date" name="date" required>
            </div>

            <div class="mb-3">
                <label for="recurring_interval" class="form-label">Recurring Expense</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-repeat"></i></span>
                    <select class="form-select" id="recurring_interval" name="recurring_interval" onchange="toggleRecurringOptions()">
                        <option value="none" selected>Not recurring</option>
                        <option value="monthly">Monthly</option>
                        <option value="biannual">Every 6 months</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>
                <div class="form-text">Select if this expense recurs on a regular schedule</div>
            </div>

            <div class="mb-3" id="recurring_day_div" style="display: none;">
                <label for="recurring_day" class="form-label">Day of Month</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-calendar-date"></i></span>
                    <input type="number" class="form-control" id="recurring_day" name="recurring_day" min="1" max="31" placeholder="Day of month (1-31)">
                </div>
                <div class="form-text">For monthly recurring expenses, specify which day of the month</div>
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="addExpenseForm" class="btn btn-primary">Add Expense</button>
      </div>
    </div>
  </div>
</div>

<script>
// Function to toggle recurring day field visibility in add expense modal
function toggleRecurringOptions() {
    const recurringInterval = document.getElementById('recurring_interval').value;
    const recurringDayDiv = document.getElementById('recurring_day_div');
    
    // Only show recurring day field for monthly recurrences
    recurringDayDiv.style.display = recurringInterval === 'monthly' ? 'block' : 'none';
    
    // If the date field has a value, extract the day for monthly recurrences
    if (recurringInterval === 'monthly') {
        const dateField = document.getElementById('date');
        if (dateField.value) {
            const selectedDate = new Date(dateField.value);
            const dayOfMonth = selectedDate.getDate();
            document.getElementById('recurring_day').value = dayOfMonth;
        }
    }
}

// Function to toggle recurring day field visibility in edit expense modal
function toggleEditRecurringOptions() {
    const recurringInterval = document.getElementById('edit_recurring_interval').value;
    const recurringDayDiv = document.getElementById('edit_recurring_day_div');
    
    // Only show recurring day field for monthly recurrences
    recurringDayDiv.style.display = recurringInterval === 'monthly' ? 'block' : 'none';
    
    // If the date field has a value, extract the day for monthly recurrences
    if (recurringInterval === 'monthly') {
        const dateField = document.getElementById('edit_date');
        if (dateField.value) {
            const selectedDate = new Date(dateField.value);
            const dayOfMonth = selectedDate.getDate();
            document.getElementById('edit_recurring_day').value = dayOfMonth;
        }
    }
}

// Function to confirm expense deletion
function confirmDeleteExpense(id, description) {
    // Set the expense ID in the form
    document.getElementById('delete_expense_id').value = id;
    
    // Set the description in the confirmation message
    const descriptionElement = document.getElementById('deleteExpenseDescription');
    if (description) {
        descriptionElement.textContent = description;
    } else {
        descriptionElement.textContent = 'Expense #' + id;
    }
    
    // Open the delete confirmation modal
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteExpenseModal'));
    deleteModal.show();
}

// Function to open and populate the edit expense modal
function openEditModal(id, date, amount, description, expenseTypeId, recurringInterval, recurringDay) {
    // Set values in the form
    document.getElementById('edit_expense_id').value = id;
    document.getElementById('edit_date').value = date;
    document.getElementById('edit_amount').value = amount;
    document.getElementById('edit_description').value = description;
    document.getElementById('edit_expense_type_id').value = expenseTypeId;
    document.getElementById('edit_recurring_interval').value = recurringInterval || 'none';
    
    // Handle recurring day field
    toggleEditRecurringOptions(); // This will handle showing/hiding the recurring day field
    if (recurringInterval === 'monthly' && recurringDay) {
        document.getElementById('edit_recurring_day').value = recurringDay;
    }
    
    // Open the modal
    const editModal = new bootstrap.Modal(document.getElementById('editExpenseModal'));
    editModal.show();
}

// Initialize everything when the DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Set today's date as default when the add expense modal is shown
    const addExpenseModal = document.getElementById('addExpenseModal');
    if (addExpenseModal) {
        addExpenseModal.addEventListener('shown.bs.modal', function() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('date').value = `${year}-${month}-${day}`;
            
            // Initialize recurring options
            toggleRecurringOptions();
            
            // Set up date field to update recurring day when changed
            document.getElementById('date').addEventListener('change', function() {
                if (document.getElementById('recurring_interval').value === 'monthly') {
                    const selectedDate = new Date(this.value);
                    const dayOfMonth = selectedDate.getDate();
                    document.getElementById('recurring_day').value = dayOfMonth;
                }
            });
        });
    }
    
    // Automatically show modal if there's an error or show_modal flag is set
    const showModalInput = document.getElementById('show_modal');
    if (showModalInput && showModalInput.value === 'true') {
        const modal = new bootstrap.Modal(addExpenseModal);
        modal.show();
    }
    
    // Add event listeners for edit buttons
    document.querySelectorAll('.edit-expense-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            const id = this.dataset.id;
            const date = this.dataset.date;
            const amount = this.dataset.amount;
            const description = this.dataset.description;
            const expenseTypeId = this.dataset.expenseTypeId;
            const recurringInterval = this.dataset.recurringInterval;
            const recurringDay = this.dataset.recurringDay;
            
            openEditModal(id, date, amount, description, expenseTypeId, recurringInterval, recurringDay);
        });
    });
    
    // Add event listeners for delete buttons
    document.querySelectorAll('.delete-expense-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            const id = this.dataset.id;
            const description = this.dataset.description;
            
            confirmDeleteExpense(id, description);
        });
    });
});
</script>

<!-- Edit Expense Modal -->
<div class="modal fade" id="editExpenseModal" tabindex="-1" aria-labelledby="editExpenseModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="section-header d-flex align-items-center justify-content-between w-100" style="border-radius: 0.75rem 0.75rem 0 0;">
  <span class="section-header-title mb-0" id="editExpenseModalLabel">Edit Expense</span>
  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
      <div class="modal-body">
        {% if edit_error %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                {{ edit_error }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endif %}

        <form id="editExpenseForm" method="POST" action="{{ url_for('expense_routes.edit_expense') }}">
            <input type="hidden" id="edit_expense_id" name="expense_id" value="">
            <input type="hidden" name="month_id" value="{{ month_data.id }}">
            
            <div class="row g-3">
                <div class="col-md-6 mb-3">
                    <label for="edit_amount" class="form-label fw-medium">Amount ($)</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-currency-dollar"></i></span>
                        <input type="number" step="0.01" class="form-control form-control-lg" id="edit_amount" name="amount" required>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label for="edit_date" class="form-label fw-medium">Date</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-calendar-date"></i></span>
                        <input type="date" class="form-control form-control-lg" id="edit_date" name="date" required>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label for="edit_description" class="form-label fw-medium">Description</label>
                <textarea class="form-control" id="edit_description" name="description" rows="2" placeholder="What was this expense for?"></textarea>
            </div>

            <div class="mb-3">
                <label for="edit_expense_type_id" class="form-label fw-medium">Expense Category</label>
                <select class="form-select form-select-lg" id="edit_expense_type_id" name="expense_type_id" required>
                    {% for type in expense_types %}
                        <option value="{{ type.id }}">{{ type.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label for="edit_recurring_interval" class="form-label fw-medium">Recurring Expense</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-repeat"></i></span>
                    <select class="form-select" id="edit_recurring_interval" name="recurring_interval" onchange="toggleEditRecurringOptions()">
                        <option value="none">Not recurring</option>
                        <option value="monthly">Monthly</option>
                        <option value="biannual">Every 6 months</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>
                <div class="form-text">Select if this expense recurs on a regular schedule</div>
            </div>

            <div class="mb-3" id="edit_recurring_day_div" style="display: none;">
                <label for="edit_recurring_day" class="form-label fw-medium">Day of Month</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-calendar-date"></i></span>
                    <input type="number" class="form-control" id="edit_recurring_day" name="recurring_day" min="1" max="31" placeholder="Day of month (1-31)">
                </div>
                <div class="form-text">For monthly recurring expenses, specify which day of the month</div>
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="editExpenseForm" class="btn btn-primary px-4">Update Expense</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteExpenseModal" tabindex="-1" aria-labelledby="deleteExpenseModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteExpenseModalLabel">Confirm Delete</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this expense?</p>
        <p id="deleteExpenseDescription" class="fw-bold"></p>
        <form id="deleteExpenseForm" method="POST" action="{{ url_for('expense_routes.delete_expense') }}">
          <input type="hidden" id="delete_expense_id" name="expense_id" value="">
          <input type="hidden" name="month_id" value="{{ month_data.id }}">
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="deleteExpenseForm" class="btn btn-danger">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Initialize tooltips for recurring expense instances -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize all tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl, {
                placement: 'top',
                trigger: 'hover'
            });
        });
    });
</script>

{% endblock %}
